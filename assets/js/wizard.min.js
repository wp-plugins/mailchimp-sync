!function(){"use strict";var a=function(a){this.id=m.prop(a.ID),this.username=m.prop(a.username),this.email=m.prop(a.email)},b={};b.askToStart=function(){var a=confirm("Are you sure you want to start synchronising all of your users? This can take a while if you have many users, please don't close your browser window.");a&&b.start()},b.start=function(){b.vm.isRunning(!0),m.redraw();var c={action:"mcs_wizard",mcs_action:"get_users"};m.request({method:"GET",url:ajaxurl,data:c,type:a}).then(b.vm.users).then(function(){b.vm.batches(b.prepareBatches()),b.processNextBatch()})},b.prepareBatches=function(){var a=b.vm.users(),c=[],d=Math.ceil(a.length/10);for(1>d?d=1:d>50&&(d=50);a.length;)c.push(a.splice(0,d));return c},b.processNextBatch=function(){b.processBatch().then(function(){b.vm.currentBatchIndex(b.vm.currentBatchIndex()+1);var a=100/b.vm.batches().length;b.vm.progress(Math.round(a*b.vm.currentBatchIndex())),m.redraw(),b.vm.currentBatchIndex()<b.vm.batches().length&&b.processNextBatch()})},b.processBatch=function(){for(var a=b.vm.batches()[b.vm.currentBatchIndex()],c=0;c<a.length;c++)b.addLogItem("Subscribing or updating <strong>user #"+a[c].id()+"</strong> with username <strong>"+a[c].username()+"</strong> and email <strong>"+a[c].email()+"</strong>.");var d={action:"mcs_wizard",mcs_action:"subscribe_users",user_ids:a.map(function(a){return a.id()})};return m.request({method:"GET",data:d,url:ajaxurl})},b.addLogItem=function(a){var c=b.vm.logItems();c.push(a),b.vm.logItems(c)},b.vm=function(){var a={};return a.init=function(){a.isRunning=m.prop(!1),a.users=m.prop([]),a.currentBatchIndex=m.prop(0),a.progress=m.prop(0),a.batches=m.prop([]),a.logItems=m.prop([])},a}(),b.controller=function(){b.vm.init()},b.view=function(){return b.vm.isRunning()?[m("div.progress-bar",[m("div.value",{style:"width: "+b.vm.progress()+"%"}),m("div.text",{},b.vm.progress()+"%")]),m("div.log",[b.vm.logItems().map(function(a){return m("p",m.trust(a))})])]:m("p",[m("input",{type:"submit","class":"button",value:"Synchronise All",onclick:b.askToStart})])},m.module(document.getElementById("wizard"),b)}();