!function(){"use strict";var a=function(a){this.id=m.prop(a.ID),this.username=m.prop(a.username),this.email=m.prop(a.email)},b=function(){var a=this;this.items=m.prop([]),this.addLine=function(b){var c={time:new Date,text:b};a.items().push(c),m.redraw()},this.addTextToLastLine=function(b){var c=a.items().pop();c.text+=" "+b,a.items().push(c),m.redraw()},this.scrollToBottom=function(a){a.scrollTop=a.scrollHeight},this.render=function(){return m("div.log",{config:a.scrollToBottom},[a.items().map(function(a){var b=("0"+a.time.getHours()).slice(-2)+":"+("0"+a.time.getMinutes()).slice(-2)+":"+("0"+a.time.getSeconds()).slice(-2);return m("p",[m("span.time",b),m.trust(a.text)])})])}},c={};c.askToStart=function(){var a=confirm("Are you sure you want to start synchronising all of your users? This can take a while if you have many users, please don't close your browser window.");a&&c.start()},c.start=function(){c.vm.isRunning(!0);var b={action:"mcs_wizard",mcs_action:"get_users"};c.vm.log.addLine("Fetching users.."),m.request({method:"GET",url:ajaxurl,data:b,type:a}).then(function(a){c.vm.log.addLine("Fetched "+a.length+" users."),c.vm.users(a),c.vm.userCount(a.length),c.subscribeNextUser()},function(a){c.vm.log.addLine("Error fetching users. Error: "+a)})},c.subscribeNextUser=function(){var a=c.vm.users(),b=0;if(0==a.length)return!1;var d=a.shift();c.vm.log.addLine("Synchronising <strong>user #"+d.id()+" "+d.username()+"</strong> (Email: <strong>"+d.email()+"</strong>).");var e={action:"mcs_wizard",mcs_action:"subscribe_users",user_ids:[d.id()]};m.request({method:"GET",data:e,url:ajaxurl}).then(function(a){c.vm.log.addTextToLastLine(a.success?"Success!":"Error."),c.updateProgress(),window.clearTimeout(b),c.subscribeNextUser()},function(a){c.vm.log.addLine("Error: "+a)}),b=setTimeout(c.subscribeNextUser,500)},c.updateProgress=function(){var a=Math.round((c.vm.userCount()-c.vm.users().length)/c.vm.userCount()*100);c.vm.progress(a),100===a&&c.vm.log.addLine("Done!")},c.vm=function(){var a={};return a.init=function(){a.isRunning=m.prop(!1),a.users=m.prop([]),a.userCount=m.prop(0),a.progress=m.prop(0),a.log=new b},a}(),c.controller=function(){c.vm.init()},c.view=function(){var a=c.vm;return a.isRunning()?[m("div.progress-bar",[m("div.value",{style:"width: "+c.vm.progress()+"%"}),m("div.text",{},100==a.progress()?"Done!":"Working: "+c.vm.progress()+"%")]),c.vm.log.render()]:m("p",[m("input",{type:"submit","class":"button",value:"Synchronise All",onclick:c.askToStart})])},m.module(document.getElementById("wizard"),c)}();